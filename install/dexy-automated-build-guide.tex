\documentclass{tufte-handout}

\hypersetup{colorlinks}

%\geometry{showframe}% for debugging purposes -- displays the margins

\usepackage{amsmath}

% Set up the images/graphics package
\usepackage{graphicx}
\setkeys{Gin}{width=\linewidth,totalheight=\textheight,keepaspectratio}

\title{Dexy Automated Builds}
\author{Ana Nelson}

% The following package makes prettier tables.  We're all about the bling!
\usepackage{booktabs}

% The units package provides nice, non-stacked fractions and better spacing
% for units.
\usepackage{units}

% The fancyvrb package lets us customize the formatting of verbatim
% environments.  We use a slightly smaller font.
\usepackage{fancyvrb}
\fvset{fontsize=\normalsize}

% Small sections of multiple columns
\usepackage{multicol}


<< pygments['pastie.tex'] >>


\begin{document}

\maketitle

\begin{abstract}
Before you begin, you should make sure you have the most recent version of this document. You can obtain this from here \url{http://dexy.it/install/dexy-automated-build-guide.pdf}. Visit \url{http://dexy.it} for more information about Dexy. Instructions for installing Dexy are available at \url{http://dexy.it/install} and these will suffice in most circumstances. This document goes into more detail about Dexy's automated build setup and installing the other software needed to run various Dexy example projects.

The sources and scripts for this guide are part of the dexy-site repository \url{http://github.com/ananelson/dexy-site/}.

\end{abstract}

\section{Automated Build}

The instructions in this document, such as the install script in the previous section, are validated by running them on virtual machines within Amazon's EC2 infrastructure, and then saving the output to S3.

\noindent The following convenience function is called to run scripts on EC2 instances:
<< d['run-builds.sh|idio|l']['function'] >>

This function captures the output from each script and uploads it, along with any generated artifacts, to S3.

\noindent This function is called as follows:
<< d['run-builds.sh|idio|l']['run-scripts'] >>

So we pass the name of the script, the AMI identifier, and the instance size we
wish to use. The \verb=run_script_in_ec2= function will start the instance and
pass the script we wish to run, and it makes sure that the result of running
our script will be saved in a log file for later.

The contents of \verb=_ec2_script_header.sh= look like:
<< d['_ec2_script_header.sh|idio|l'] >>

And the \verb=_ec2_script_footer.sh= looks like:
<< d['_ec2_script_footer.sh|idio|l'] >>

The AMIs currently in use are:
<< d['run-builds.sh|idio|l']['amis'] >>

The custom AMI is private, however it can be replicated by running an install
script on the Ubuntu AMI, as per this example: <<
d['create-custom-ami.sh|idio|l'] >>

By running this on an elastic boot store (EBS)-based AMI, the resulting virtual
machine image can be snapshotted and turned into an AMI. So in this way we can
easily create AMIs with have all the software we need to run the Dexy examples,
and which are easy to update and modify if we need to change our environment.
The \verb=full-setup-ubuntu.sh= script will be discussed in the next section.

\section{Building the Environment}

In this section we discuss the full-setup-ubuntu.sh script which is used to generate a custom AMI.

We get the code name of the Ubuntu release we are running on, e.g. 'natty'. We will use this later:
<< d['full-setup-ubuntu.sh|idio|l']['get-release-name'] >>

We make sure our package definitions are up to date and ugprade all packages:
<< d['full-setup-ubuntu.sh|idio|l']['update-package-manager'] >>

We need to make some additional sources available to us, in particular for installing R related software:
<< d['full-setup-ubuntu.sh|idio|l']['additional-sources'] >>

Now that we are set up, we can install the software we will need to run the various Dexy demos and examples:
<< d['full-setup-ubuntu.sh|idio|l']['sys-installs'] >>

Next we can install some Ruby gems:
<< d['full-setup-ubuntu.sh|idio|l']['ruby-installs'] >>

and some Python packages:
<< d['full-setup-ubuntu.sh|idio|l']['python-installs'] >>

and some R packages:
<< d['full-setup-ubuntu.sh|idio|l']['r-installs'] >>

although we installed asciidoc above, we want a more recent version:
<< d['full-setup-ubuntu.sh|idio|l']['install-asciidoc'] >>

install clojure and move the JAR:
<< d['full-setup-ubuntu.sh|idio|l']['install-clojure'] >>

That's everything, we want to shut down the instance once we've finished installing everything:
<< d['full-setup-ubuntu.sh|idio|l']['shutdown'] >>

Recall that our script specified the instance should be stopped, not terminated, on shutdown. So once we see that the instance is stopped we can manually create an AMI with all this software installed.

\section{Installing and Testing Dexy}

The \verb=source-install.sh= script installs Dexy from source and runs a number of tests, including generating the Dexy website. The idea of this script is to check that various commands function as expected. These commands are then used in the installation page to describe how to do various tasks.

Install the most recent Dexy from source:
<< d['source-install.sh|idio|l']['source-install'] >>

Run the unit tests:
<< d['source-install.sh|idio|l']['nosetests'] >>

Test various dexy commands:
<< d['source-install.sh|idio|l']['dexy-version'] >>
<< d['source-install.sh|idio|l']['dexy-help'] >>
<< d['source-install.sh|idio|l']['list-filters'] >>
<< d['source-install.sh|idio|l']['list-filters'] >>

Run dexy on a test template:
<< d['source-install.sh|idio|l']['run-dexy-test-template'] >>

Generate the dexy site:
<< d['source-install.sh|idio|l']['dexy-site'] >>

\end{document}

